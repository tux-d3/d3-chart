<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../tux-d3/tux-d3.html">
<dom-module id='d3-chart'>
    <template>
        <style>
        :host ::content #chart rect {
          fill: steelblue;
        }

        :host ::content #chart text {
          fill: white;
          font: 10px sans-serif;
          text-anchor: end;
        }

        :host ::content #chart text#noData {
            fill: gray;
            font: 22px "Roboto";
            text-anchor: center;
        }
        </style>
        <svg id='chart'></svg>
    </template>
    <script>
    Polymer({
        is: 'd3-chart',
        properties: {

            barHeight: {
                type: Number,
                value: 20,
                notify: true,
            },

            data: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
                reflectToAttribute: true
            },

            width: {
                type: Number,
                value: 420,
                notify: true
            }
        },

        observers: [ '_refresh(barHeight, data.splices, width)' ],

        attached: function() {
            var self = this;
            self.async(self._refresh);
        },
        _refresh: function(barHeight, data, width) {
            var self = this;
            self._drawChart();
        },

        _drawChart: function() {
            var self = this;


            var chart = d3.select(self.$.chart)
                .attr("width", self.width)
                .attr("height", self.barHeight * self.data.length);

            if(self.data.length === 0) {
                chart.attr("height", 40);
                chart.append("text")
                    .attr("id", "noData")
                    .attr("x", "50%")
                    .attr("y", "30")
                    .text("No Data");
                return ;
            }

            chart.select("#noData").remove();

            var groups = chart.selectAll("g")
                .data(self.data, function(d, i) { return i; });

            var bar = groups.enter().append("g");

            bar.append("rect");
            bar.append("text");


            var x = d3.scale.linear()
                    .domain([0, d3.max(self.data)])
                    .range([0, self.width]);


            var bars = chart.selectAll('g');
            bars.attr("transform", function(d, i) { return "translate(0," + i * self.barHeight + ")"; });
            bars.selectAll('rect')
                .attr('width', function(d) { return x(d); })
                .attr("height", self.barHeight - 1);

            bars.selectAll('text')
                .attr("x", function(d) { return x(d) - 3; })
                .attr("y", self.barHeight / 2)
                .attr("dy", ".35em")
                .text(function(d) { return d; });

            groups.exit().remove();

        }
    });
    </script>
</dom-module>
